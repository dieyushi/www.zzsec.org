
<!DOCTYPE html>
<html dir="ltr" lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="author" content="dieyushi">
        <meta name="keywords" content="dieyushi's Blog" />
        <meta name="description" content="dieyushi's Blog - dieyushi" />
        <link rel="stylesheet" type="text/css" media="all" href="/assets/themes/ilost/style.css" />
        <link rel="stylesheet" type="text/css" media="all" href="/assets/themes/ilost/pygments.css" />
        <link href="atom.xml" type="application/atom+xml" rel="alternate" title="dieyushi's Blog  &raquo; ATOM Feed">
        <title>Install Nginx in OpenShift - dieyushi's Blog</title>
    </head>

    <body class="single single-format-standard">
        <header>
        <form role="search" method="get" id="searchform" action="http://www.google.com/search" >
            <div>
                <input type="text" value="" name="as_q" id="s" />
                <input type="hidden" name="sitesearch" value="http://www.zzsec.org" />
            </div>
        </form>
        <div class="hgroup">
            <h1><a href="/">dieyushi's Blog</a></h1>
            <span class="hidden">dieyushi</span>
            <a class="feedrss" href="/atom.xml">ATOM Rss</a>
        </div>
        <div class="menu">
            <ul>
                <li><a href="/" title="Home">Home</a></li>
                <li class="page_item"><a href="/archive.html">Archive</a></li>
                <li class="page_item"><a href="/categories.html">Categories</a></li>
                <li class="page_item"><a href="/tags.html">Tags</a></li>
            </ul>
        </div>
        </header>
        <hr/>
        <div id="content">
            
<article>
  <section class="post type-post status-publish format-standard hentry">
    <div class="title">
      <h2>Install Nginx in OpenShift</h2>
      <small>
        <date class="date-pub" title="2013-03-22T00:00:00+08:00" datetime="2013-03-22T00:00:00+08:00" pubdate>
          <span class="month">March</span>
          <span class="day">22</span>
          <span class="year">2013</span>
        </date>, 
				
        
           
            <a href="/categories.html#life-ref" rel="category tag">life</a>
          
        
      </small>
    </div>
    <div class="entry">
      <h3>前言</h3>

<p>这几天将博客搬移到了<code>OpenShift</code>上，使用它的<code>DIY app</code>，搭建了一个<code>Nginx</code>环境用来跑我的静态博客。<code>OpenShift</code>使用的是<code>Amazon</code>的主机，国内访问有点慢，通过<code>CloudFlare</code>来做<code>CDN</code>感觉效果不是很明显，但是考虑到博客主要是自己访问，通过代理速度还可以接受，毕竟<code>CloudFlare</code>能够使网站在全美国的<code>ping</code>在10ms左右。</p>

<h3>OpenShift简介</h3>

<p><a href="https://openshift.redhat.com"><strong>OpenShift</strong></a>是Red Hat公司推出的一个PaaS，支持Java、PHP、Perl、Ruby等很多的开发框架，开发者通过<code>git</code>来部署代码，也可以通过ssh登录到主机进行配置。OpenShift对于免费用户的一些限制参考这个<a href="https://www.openshift.com/faq/how-many-applications-can-i-deploy-and-what-resource-limitations-would-they-have">页面</a>。</p>

<!--more-->

<h3>创建OpenShift applications</h3>

<p>创建一个新的app，名为blog。</p>
<div class="highlight"><pre><code class="text">rhc app create blog diy-0.1
</code></pre></div>
<p>查看blog的相关信息。</p>
<div class="highlight"><pre><code class="text">rhc app show -a blog
</code></pre></div>
<p>使用上个命令列出的信息ssh到服务器，形式大概是：</p>
<div class="highlight"><pre><code class="text">ssh &lt;random-strings&gt;@blog-&lt;your-namespace&gt;.rhcloud.com
</code></pre></div>
<p>系统中默认会有一些定义好了的环境变量(<a href="https://www.openshift.com/page/openshift-environment-variables">点我查看</a>),再接下来的配置中会用到。</p>

<h3>安装Nginx</h3>

<p>现在就可以进行<code>nginx</code>的安装了。首先要下载<code>nginx</code>的源码</p>
<div class="highlight"><pre><code class="text">cd $OPENSHIFT_TMP_DIR
wget http://nginx.org/download/nginx-1.2.7.tar.gz
tar zxf nginx-1.2.7.tar.gz
</code></pre></div>
<p>编译nginx需要PRCE。</p>
<div class="highlight"><pre><code class="text">cd $OPENSHIFT_TMP_DIR
wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.31.tar.bz2
tar jxf prce-8.31.tar.bz2
cf nginx-1.2.7
./configure --prefix=$OPENSHIFT_DATA_DIR --with-pcre=$OPENSHIFT_TMP_DIR/pcre-8.31
make Install
</code></pre></div>
<p>编译完成后，<code>nginx</code>将会被装到<code>$OPENSHIFT_DATA_DIR</code>中。</p>

<h3>配置Nignx</h3>

<p><code>OpenShift</code>只允许使用<code>$OPENSHIFT_INTERNAL_IP</code>和<code>OPENSHIFT_INTERNAL_PORT</code>，在<code>nginx</code>的<code>http</code>，<code>server</code>和<code>location</code>不能直接使用这些环境变量，所以我们用了点小技巧。</p>
<div class="highlight"><pre><code class="text">vi $OPENSHIFT_DATA_DIR/conf/nginx.conf
</code></pre></div>
<p>编辑<code>listen</code>的值为</p>
<div class="highlight"><pre><code class="text">http {
    ...
    server {
        listen $OPENSHIFT_IP:$OPENSHIFT_PORT;
        server_name localhost;
        ...
    }
    ...
}
</code></pre></div>
<p>把这个作为模板，在app启动的时候生成配置文件</p>
<div class="highlight"><pre><code class="text">mv $OPENSHIFT_DATA_DIR/conf/nginx.conf $OPENSHIFT_DATA_DIR/conf/nginx.conf.template
</code></pre></div>
<h3>编写start和stop脚本</h3>

<p>在程序代码中编辑<code>.openshift/action_hooks/start</code>，内容为：</p>
<div class="highlight"><pre><code class="text">cd blog
vim .openshift/action_hooks/start
</code></pre></div><div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
<span class="c"># The logic to start up your application should be put in this</span>
<span class="c"># script. The application will work only if it binds to</span>
<span class="c"># $OPENSHIFT_INTERNAL_IP:8080</span>
<span class="c"># nohup $OPENSHIFT_REPO_DIR/diy/testrubyserver.rb $OPENSHIFT_INTERNAL_IP $OPENSHIFT_REPO_DIR/diy &gt; $OPENSHIFT_DIY_LOG_DIR/server.log 2&gt;&amp;1 &amp;</span>
<span class="c"># replace the $OPENSHIFT_INTERNAL_IP and $OPENSHIFT_INTERNAL_PORT before starting up the server</span>
sed -e <span class="s2">&quot;s/`echo &#39;$OPENSHIFT_IP:$OPENSHIFT_PORT&#39;`/`echo $OPENSHIFT_INTERNAL_IP:$OPENSHIFT_INTERNAL_PORT`/&quot;</span> <span class="nv">$OPENSHIFT_DATA_DIR</span>/conf/nginx.conf.template &gt; <span class="nv">$OPENSHIFT_DATA_DIR</span>/conf/nginx.conf
nohup <span class="nv">$OPENSHIFT_DATA_DIR</span>/sbin/nginx &gt; <span class="nv">$OPENSHIFT_DIY_LOG_DIR</span>/server.log 2&gt;&amp;1 &amp;
</code></pre></div><div class="highlight"><pre><code class="text">vi ./openshift/action_hooks/stop
</code></pre></div><div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>
ps -ef | grep nginx | <span class="k">while </span><span class="nb">read </span>line
<span class="k">do</span>
<span class="k">  </span><span class="nb">kill</span> -9 <span class="sb">`</span><span class="nb">echo</span> <span class="nv">$line</span> | awk <span class="s1">&#39;{ print $2 }&#39;</span><span class="sb">`</span>
<span class="k">done</span>
<span class="nb">exit </span>0
</code></pre></div>
<p>提交代码，然后就可以用<code>rhc app start|stop|restart blog</code>了。</p>

<blockquote>
<p><code>PS</code>:当<code>nginx</code>使用3xx重定向请求时，指向的是<code>appname.rhcloud.com:8080</code>,8080是内部监听端口，从外部请求8080端口将会超时，解决这个问题需要在nginx配置的<code>http</code>部分中添加<code>port_in_redirect off;</code>。</p>
</blockquote>

<h3>参考</h3>

<ol>
<li><a href="http://shawhu.org/2012-10/Jekyll-OpenShift/">http://shawhu.org/2012-10/Jekyll-OpenShift/</a></li>
<li><a href="https://www.openshift.com/blogs/lightweight-http-serving-using-nginx-on-openshift">https://www.openshift.com/blogs/lightweight-http-serving-using-nginx-on-openshift</a></li>
</ol>

    </div>
    <div class="post-meta">
      标签：
      
      


    
    
      
      <a href="/tags.html#blog-ref" class="tag-link" style="font-size: 11pt;">blog</a>
    
      
      <a href="/tags.html#config-ref" class="tag-link" style="font-size: 11pt;">config</a>
    
  




      <div class="clear"></div>
    </div>
    <nav class="post-nav">
      
      <span class="previous"><a href="/2013/03/build-jekyll-in-heroku" rel="prev" title="heroku部署jekyll">heroku部署jekyll</a></span>
      
      
      <span class="next"><a href="/2013/03/something-about-httponly" rel="next" title="HttpOnly的那些事">HttpOnly的那些事</a></span>
      
      <div class="clear"></div>
    </nav>
  </section>
  <div class="comment">
  


  <div id="disqus_thread"></div>
<script type="text/javascript">
    
    var disqus_shortname = 'zzsec'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>





  </div>
  <div class="sharing">
  

  
        <!-- JiaThis Button BEGIN -->
<script type="text/javascript" >
var jiathis_config={
	data_track_clickback:true,
	siteNum:14,
	sm:"twitter,googleplus,fb,gmail,evernote,readitlater,print,email,tsina,tqq,renren,douban,weixin,ydnote",
	summary:"",
	showClose:true,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1334747872812250" charset="utf-8"></script>
<!-- JiaThis Button END -->

  



  </div>
</article>


            <aside>
            <ul id="side" class="clear">
                <li id="links-2" class="widget widget_links"><h3 class="widgettitle">About Me</h3>
                <ul class='xoxo blogroll'>
                    <li><a href="mailto:zz@zzsec.org" target="_blank" rel="me">Gtalk</a></li>
                    <li><a href="https://twitter.com/zzscu" target="_blank" rel="me">Twitter</a></li>
                    <li><a href="https://github.com/dieyushi/" target="_blank" rel="me">GitHub</a></li>
                    <li><a href="https://plus.google.com/108491501040349109978" target="_blank" rel="me">Google+</a></li>
                </ul>
                </li>
                <li id="tagcloud-2" class="widget">
                <h3 class="widgettitle">Tag Cloud</h3>
                <div class="post-meta">
                    
                    


    
    
      
      <a href="/tags.html#blog-ref" class="tag-link" style="font-size: 11pt;">blog</a>
    
      
      <a href="/tags.html#config-ref" class="tag-link" style="font-size: 11pt;">config</a>
    
      
      <a href="/tags.html#websecurity-ref" class="tag-link" style="font-size: 9pt;">websecurity</a>
    
      
      <a href="/tags.html#xss-ref" class="tag-link" style="font-size: 9pt;">xss</a>
    
      
      <a href="/tags.html#archlinux-ref" class="tag-link" style="font-size: 9pt;">archlinux</a>
    
      
      <a href="/tags.html#python-ref" class="tag-link" style="font-size: 9pt;">python</a>
    
      
      <a href="/tags.html#google-ref" class="tag-link" style="font-size: 9pt;">google</a>
    
      
      <a href="/tags.html#kindle-ref" class="tag-link" style="font-size: 9pt;">kindle</a>
    
  




                </div>
                </li>
                <li id="recent-posts-2" class="widget widget_recent_entries">
                <h3 class="widgettitle">Recent Posts</h3>
                <ul>
                    
                    <li><a href="/2013/04/kindle" title="kindle的那些事">kindle的那些事</a></li>
                    
                    <li><a href="/2013/04/google-account-automatic-registration" title="google注册过程分析">google注册过程分析</a></li>
                    
                    <li><a href="/2013/03/clean-pacman-cache" title="Pacman缓存清理">Pacman缓存清理</a></li>
                    
                    <li><a href="/2013/03/something-about-httponly" title="HttpOnly的那些事">HttpOnly的那些事</a></li>
                    
                    <li><a href="/2013/03/install-nginx-in-openshift" title="Install Nginx in OpenShift">Install Nginx in OpenShift</a></li>
                    
                    <li><a href="/2013/03/build-jekyll-in-heroku" title="heroku部署jekyll">heroku部署jekyll</a></li>
                    
                    <li><a href="/2013/03/new-blog" title="New Blog">New Blog</a></li>
                    
                </ul>
                </li>
                <li id="recent-comments-2" class="widget widget_recent_comments">
                <h3 class="widgettitle">Recent Comments</h3>
                <script type="text/javascript" src="http://zzsec.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=32&excerpt_length=50"></script>
                </li>
            </ul>
            </aside>
            <div class="clear"></div>
        </div>
        <hr/>
        <footer>
        <div>
            <p class="line">
            <span class="alignright">
                <a href="/" title="dieyushi's Blog">首页</a> &brvbar; <a href="/atom.xml">RSS 订阅</a> &brvbar; <a href="/sitemap.txt">Sitemap</a>
            </span>
            iLost theme  &brvbar; Designed by <a href="http://xuui.net/">Xu.hel</a> in ChengDu. Forked by <a href="http://www.zzsec.org/">zzsec</a>.
            </p>
            <p><span class="alignright">Powered by <a href="https://github.com/mojombo/jekyll">Jekyll</a></span>&copy; 版权所有 2011-2013 <a href="http://www.zzsec.org" title="dieyushi's Blog" rel="home">dieyushi's Blog</a></p>
        </div>
        </footer>
        


  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-39425016-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



    </body>
</html>

